<page-meta page-style="{{ showBeforeAddScenePopup || showAddScenePopup ? 'overflow: hidden;' : '' }}" />
<!-- 背景 -->
<view class="w-100vw h-100vh fixed left-0 top-0 bg-hex-f4f8ff bg-z-index-1"></view>
<view class="fixed left-0 top-0 w-100vw h-50vh bg-z-index" style="background: linear-gradient(180deg, rgba(87, 105, 255, 0.1) 0%, rgba(87, 105, 255, 0) 100%)"></view>

<!-- 场景卡片使用提示 -->
<view wx:if="{{showAddSceneTips}}" class="fixed rounded-24rpx tips-shadow z-115" style="{{sceneTipsPositionStyle}}">
  <view class="w-344rpx h-138rpx rounded-26rpx tips-dialog absolute right-0 z-116">
    <view class="wh-full flex-col-center">
      <text class="text-24rpx text-white">点击此处可创建一个新场景</text>
      <view class="w-full flex justify-end">
        <view class="bg-hex-7bb1ff rounded-32rpx mt-26rpx mr-22rpx flex" bindtap="handleKnownAddSceneTap">
          <text class="text-20rpx text-white leading-none mx-16rpx my-12rpx">我知道了</text>
        </view>
      </view>
    </view>
    <view class="tips-dialog-arrow"></view>
  </view>
</view>
<!-- 收藏场景提示 -->
<view wx:if="{{showAddSceneSuccess}}" class="flex-center rounded-16rpx px-22rpx py-8rpx fixed bg-hex-000 opacity-73 z-115" style="left: {{sceneTitlePosition.x}}px; top: calc({{sceneTitlePosition.y}}px - 60rpx);">
  <view class="relative">
    <view class="arrow absolute w-0 h-0"></view>
  </view>
  <text class="text-white text-26rpx">您创建了一个新的场景</text>
</view>

<!-- 页面主体，全屏幕点击捕获 -->
<view bindtap="handleScreenTap" bindtouchmove="handleScreenTap">
  <!-- 标题 -->
  <nav-bar title="{{title}}" z-index="{{113}}" left-arrow bind:leftTap="goBack" disabled="{{opacity === 0}}"></nav-bar>
  <!-- 房间无子设备,但是有网关 -->
  <view wx:if="{{roomHasGateway && !roomHasSubDevice}}" class="w-full flex flex-col items-center">
    <image src="/assets/img/default-img/only-gateway.png" class="w-300rpx h-300rpx mt-64rpx"></image>
    <text class="text-black-59 text-28rpx mt-48rpx">智能网关非可控制设备</text>
    <text data-url="/package-mine/device-manage/index" bindtap="goTo" class="text-black-59 text-28rpx">请在<text class="mx-8rpx text-blue underline decoration-solid decoration-blue">设备管理</text>中查看</text>
    <van-button wx-if="{{canAddDevice}}" type="primary" class="mt-290rpx w-686rpx" size="large" bind:click="handleAddDevice">添加智能设备</van-button>
  </view>
  <!-- 家庭无子设备无网关 -->
  <view wx:if="{{!roomHasGateway && !roomHasSubDevice}}" class="w-full flex flex-col items-center">
    <image src="/assets/img/default-img/no-device.png" class="w-300rpx h-300rpx mt-64rpx"></image>
    <text class="text-black-59 text-28rpx mt-48rpx">这个房间空空如也</text>
    <van-button wx-if="{{canAddDevice}}" type="primary" class="mt-290rpx w-686rpx" size="large" bind:click="handleAddDevice">添加智能设备</van-button>
  </view>

  <!-- 有设备页面主体 -->
  <view wx:if="{{roomHasSubDevice}}" class="w-750rpx flex flex-col items-center">
    <view class="w-720rpx">
      <!-- 设备卡片列表 -->
      <scroll-view scroll-y enhanced show-scrollbar="{{false}}" style="height: {{ scrollViewHeight }}px;" bindscroll="onPageScroll" scroll-top="{{scrollTop}}" scroll-with-animation="{{true}}">
        <!-- 场景 -->
        <view id="scene-card" wx:if="{{roomHasSubDevice}}" class="scene-card w-686rpx h-96rpx flex items-center rounded-24rpx mt-20rpx ml-16rpx mb-12rpx relative" bindtap="handleSceneTap">
          <image src="/package-room-control/assets/img/scene.png" class="absolute left-0 top-0 w-686rpx h-96rpx scene-card-bg" />
          <image src="/assets/img/base/scene.png" class="w-64rpx h-64rpx ml-24rpx"></image>
          <text id="scene-title" class="text-32rpx text-hex-333333 font-medium ml-16rpx">场景</text>
          <view class="flex flex-1 justify-end items-center">
            <view class="mr-38rpx flex">
              <view class="scene-icon p-4rpx bg-hex-fff rounded-999" wx:for="{{sceneListInBar}}" wx:key="sceneId">
                <view class="bg-hex-eff0f3 rounded-999">
                  <svg-icon name="scene:{{item.sceneIcon}}" width="52rpx" height="52rpx" />
                </view>
              </view>
            </view>
            <van-button catchtap="handleCollect" custom-class="fav-btn" type="primary">创建</van-button>
          </view>
        </view>

        <movable-area style="height: {{movableAreaHeight}}rpx; width: 600rpx;">
          <!-- 拖动占位符 -->
          <!-- <movable-view wx:if="{{isMoving}}" x="{{placeholder.x}}" y="{{placeholder.y}}" direction="all" class="z-1">
            <view class="w-160rpx h-216rpx rounded-32rpx ml-10rpx mt-16rpx border border-solid border-blue opacity-25"></view>
          </movable-view> -->

          <view wx:for="{{devicePageList}}" wx:for-item="group" wx:key="g" wx:for-index="g" class="flex flex-row flex-wrap">
            <movable-view wx:for="{{group}}" wx:key="uniId" data-index="{{index}}" data-group="{{g}}" data-ordernum="{{item.orderNum}}" x="{{item.x}}" y="{{item.y}}" direction="all" friction="{{999}}" damping="{{100}}" bind:longpress="movableTouchStart" bind:touchend="movableTouchEnd" bind:change="movableChange" class="{{ index === placeholder.index && g === placeholder.groupIndex ? 'z-100' : 'z-1' }}" disabled="{{!isMoving}}">
              <device-card class="w-180rpx pb-16rpx pt-16rpx flex justify-center {{editSelectMode && (index !== placeholder.index || g !== placeholder.groupIndex) ? 'shake' : ''}}" showControl="{{!editSelectMode}}" showShadow showGradientBg edit-mode="{{editSelectMode}}" edit-select="{{item.editSelect}}" device-info="{{item}}" data-item="{{item}}" select="{{item.select}}" bind:controlTap="handleControlTap" bind:cardTap="handleCardTap" bind:offlineTap="handleShowDeviceOffline" bind:longPress="handleLongpress" />
            </movable-view>
          </view>
        </movable-area>

        <van-skeleton wx:if="{{!deviceListInited}}" row="1" row-width="700rpx" row-class="mt-16rpx rounded-32rpx skeleton_fix" />
        <van-skeleton wx:if="{{!deviceListInited}}" row="1" row-width="700rpx" row-class="mt-32rpx rounded-32rpx skeleton_fix" />
        <van-skeleton wx:if="{{!deviceListInited}}" row="1" row-width="700rpx" row-class="mt-32rpx rounded-32rpx skeleton_fix" />
        <van-skeleton wx:if="{{!deviceListInited}}" row="1" row-width="700rpx" row-class="mt-32rpx rounded-32rpx skeleton_fix" />

        <!-- 有列表时的添加按钮 -->
        <view class="flex-col-center py-20rpx" wx:if="{{roomHasSubDevice}}">
          <van-button wx-if="{{canAddDevice}}" type="default" color="rgba(255,255,255,0.60)" size="small" custom-class="round-btn-border" round bind:tap="goTo" data-url="/package-distribution/choose-device/index">
            <text class="text-26rpx text-hex-555659">添加设备</text>
          </van-button>
        </view>
      </scroll-view>
    </view>
  </view>
</view>

<!-- 设备控制弹窗 -->
<device-control-popup controlPopup="{{controlPopup}}" checkedList="{{checkedList}}" lightStatus="{{lightStatus}}" curtainStatus="{{curtainStatus}}" checkedType="{{checkedType}}" bind:popMove="handlePopMove" bind:updateList="updateQueue"></device-control-popup>

<before-add-scene-popup show="{{showBeforeAddScenePopup}}" bind:close="handleBeforeAddScenePopupClose" bind:next="handleBeforeAddScenePopupNext" bind:delete="handleBeforeAddScenePopupDelete" />

<add-scene-popup actions="{{addSceneActions}}" show="{{showAddScenePopup}}" bind:close="handleAddScenePopupClose" bind:confirm="handleShowAddSceneSuccess" bind:return="handleAddScenePopupReturn" />

<batch-edit bind:updateList="updateQueue" bind:roomMove="handleRoomMoveSuccess" bind:close="exitEditMode" bind:selectAll="editSelectAll" editSelectMode="{{editSelectMode}}" editSelectList="{{editSelectList}}"></batch-edit>

<van-toast id="van-toast" />

<van-dialog use-slot title="{{officeDeviceInfo.deviceName}}离线" show="{{ showDeviceOffline }}" confirm-button-color="#488FFF" confirmButtonText="我知道了" bind:close="handleCloseDeviceOffline">
  <view class="flex-col-center w-full">
    <image src="{{officeDeviceInfo.pic}}" class="w-160rpx h-160rpx mt-70rpx" />
    <view class="flex flex-col mt-88rpx">
      <text class="text-hex-555659 text-32rpx">可能的原因：</text>
      <text class="text-hex-A2A2A2 text-28rpx mt-20rpx">1、路由器密码被修改，建议将智能网关
      </text>
      <text class="text-28rpx text-blue decoration-solid decoration-blue ml-46rpx mt-8rpx" bindtap="handleRebindGateway">重新联网</text>
      <text class="text-hex-A2A2A2 text-28rpx mt-20rpx">2、设备与网关未通电</text>
      <text class="text-hex-A2A2A2 text-28rpx mt-20rpx">3、设备与网关距离过远，或有其他遮挡物</text>
      <text class="text-hex-A2A2A2 text-28rpx mt-20rpx">4、路由器未通电或网络异常</text>
    </view>
    <view class="h-80rpx"></view>
  </view>
</van-dialog>
