<page-meta page-style="{{ showBeforeAddScenePopup || showAddScenePopup ? 'overflow: hidden;' : '' }}" />
<wxs module="module" src="/commons/wxs/util.wxs"></wxs>
<!-- 背景 -->
<view class="w-100vw h-100vh fixed left-0 top-0 bg-hex-f4f8ff bg-z-index-1"></view>
<view class="fixed left-0 top-0 w-100vw h-50vh bg-z-index" style="background: linear-gradient(180deg, rgba(87, 105, 255, 0.1) 0%, rgba(87, 105, 255, 0) 100%)"></view>

<!-- 遮住顶部 -->
<view style="height: calc({{navigationBarAndStatusBarHeight}} + 136rpx);" class="fixed left-0 top-0 z-110 overflow-hidden w-750rpx">
  <view class="w-100vw h-100vh absolute left-0 top-0 bg-hex-f4f8ff z-111"></view>
  <view class="absolute left-0 top-0 w-100vw h-50vh z-112" style="background: linear-gradient(180deg, rgba(87, 105, 255, 0.1) 0%, rgba(87, 105, 255, 0) 100%)"></view>
  <!-- 场景 -->
  <view wx:if="{{roomHasSubDevice}}" class="scene-card w-686rpx h-96rpx flex items-center rounded-24rpx mt-24rpx absolute left-32rpx z-114" style="top: {{navigationBarAndStatusBarHeight}};" bindtap="handleSceneTap">
    <image src="/assets/img/device-control/scene.png" class="absolute left-0 top-0 w-686rpx h-96rpx scene-card-bg" />
    <image src="/assets/img/base/scene.png" class="w-64rpx h-64rpx ml-24rpx"></image>
    <text id="scene-title" class="text-32rpx text-hex-333333 font-medium ml-16rpx">场景</text>
    <view class="flex flex-1 justify-end items-center">
      <view class="mr-38rpx flex">
        <view class="scene-icon p-4rpx bg-hex-fff rounded-999" wx:for="{{sceneListInBar}}" wx:key="sceneId">
          <view class="bg-hex-eff0f3 rounded-999">
            <svg-icon name="scene:{{item.sceneIcon}}" width="52rpx" height="52rpx" />
          </view>
        </view>
      </view>
      <van-button catchtap="handleCollect" custom-class="fav-btn" type="primary">创建</van-button>
    </view>
  </view>
</view>

<!-- 收藏场景提示 -->
<view wx:if="{{showAddSceneSuccess}}" class="flex-center rounded-16rpx px-22rpx py-8rpx fixed bg-hex-000 opacity-73 z-115" style="left: {{sceneTitlePosition.x}}px; top: calc({{sceneTitlePosition.y}}px - 60rpx);">
  <view class="relative">
    <view class="arrow absolute w-0 h-0"></view>
  </view>
  <text class="text-white text-26rpx">您收藏了一个新的场景</text>
</view>

<!-- 全屏幕点击捕获 -->
<view bindtap="handleScreenTap" bindtouchmove="handleScreenTap">
  <!-- 标题 -->
  <nav-bar title="{{title}}" z-index="{{113}}" left-arrow bind:leftTap="goBack" disabled="{{opacity === 0}}"></nav-bar>
  <view class="h-120rpx"></view>
  <!-- 房间无子设备,但是有网关 -->
  <view wx:if="{{roomHasGateway && !roomHasSubDevice}}" class="w-full flex flex-col items-center">
    <image src="/assets/img/default-img/only-gateway.png" class="w-300rpx h-300rpx mt-64rpx"></image>
    <text class="text-black-59 text-28rpx mt-48rpx">智能网关非可控制设备</text>
    <text data-url="/package-mine/device-manage/index" bindtap="goTo" class="text-black-59 text-28rpx">请在<text class="mx-8rpx text-blue underline decoration-solid decoration-blue">设备管理</text>中查看</text>
  </view>
  <!-- 家庭无子设备无网关 -->
  <view wx:if="{{!roomHasGateway && !roomHasSubDevice}}" class="w-full flex flex-col items-center">
    <image src="/assets/img/default-img/no-device.png" class="w-300rpx h-300rpx mt-64rpx"></image>
    <text class="text-black-59 text-28rpx mt-48rpx">这个房间空空如也</text>
    <van-button type="primary" class="mt-290rpx w-686rpx" size="large" bind:click="handleAddDevice">添加智能设备</van-button>
  </view>

  <!-- 有设备页面主体 -->
  <view wx:if="{{roomHasSubDevice}}" class="w-750rpx flex flex-col items-center">
    <view class="flex flex-col items-center w-750rpx">
      <!-- 灯具设备卡片 -->
      <view class="mt-24rpx" wx:if="{{lightList && lightList.length>0}}">
        <view class="flex justify-between items-center h-44rpx">
          <text class="text-24rpx text-black-59 ml-17rpx">灯具</text>
          <view class="rounded-999 flex-center px-20rpx py-10rpx cancel-select-btn" data-type="light" bindtap="handleCancelSelce" wx:if="{{hasSelectLight}}">
            <text class="text-20rpx leading-none text-hex-555659">全不选</text>
          </view>
        </view>
        <view class="w-720rpx mt-24rpx">
          <drag id="drag-light" columns="{{4}}" list-data="{{lightList}}" scroll-top="{{scrollTop}}" item-height="{{240}}" generic:item="card" bind:sortend="handleLightSortEnd" bind:controlTap="handleLightPowerToggle" bind:cardTap="handleDeviceCardTap" bind:scroll="handleScroll" bind:offlineTap="handleShowDeviceOffline" bind:drag="handleDrag"></drag>
        </view>
      </view>

      <!-- 开关设备卡片 -->
      <view class="{{lightList && lightList.length > 0 ? '' : 'mt-24rpx'}}" wx:if="{{switchList && switchList.length>0}}">
        <view class="flex justify-between items-center h-44rpx">
          <text class="text-24rpx text-black-59 ml-17rpx">开关面板</text>
          <view class="rounded-999 flex-center px-20rpx py-10rpx cancel-select-btn" data-type="switch" bindtap="handleCancelSelce" wx:if="{{hasSelectSwitch}}">
            <text class="text-20rpx leading-none text-hex-555659">全不选</text>
          </view>
        </view>
        <view class="w-720rpx mt-24rpx">
          <drag id="drag-switch" columns="{{4}}" list-data="{{switchList}}" scroll-top="{{scrollTop}}" item-height="{{240}}" generic:item="card" bind:sortend="handleSwitchSortEnd" bind:controlTap="handleSwitchControlTapToggle" bind:cardTap="handleDeviceCardTap" bind:scroll="handleScroll" bind:offlineTap="handleShowDeviceOffline" bind:drag="handleDrag"></drag>
        </view>
      </view>

      <!-- 窗帘设备卡片 -->
      <!-- <view class="{{switchList && switchList.length > 0 ? '' : 'mt-24rpx'}}" wx:if="{{curtainList && curtainList.length>0}}">
          <text class="text-24rpx text-black-59">窗帘</text>
          <view class="w-686rpx grid grid-cols-4 gap-x-16rpx gap-y-24rpx mt-24rpx">
            <device-card class="curtain-card" showControl device-type="curtain" wx:for="{{curtainList}}" wx:key="deviceId" data-index="{{index}}" data-type="curtain" data-info="{{item}}" bind:controlTap="handleDevicecontrolTap" bindtouchend="handleTouchEnd" bind:cardTap="handleDeviceCardTap" device-info="{{item}}" select="{{module.includes(selectList, item.deviceId)}}" />
          </view>
        </view> -->
    </view>
  </view>
</view>

<view class="flex-col-center" wx:if="{{roomHasSubDevice}}">
  <view class="h-20rpx"></view>
  <van-button type="default" color="rgba(255,255,255,0.60)" size="small" custom-class="round-btn-border" round bind:tap="goTo" data-url="/package-distribution/scan/index">
    <text class="text-26rpx text-hex-555659">添加设备</text>
  </van-button>
</view>

<view wx:if="{{popupPlaceholder}}" class="h-716rpx" bindtap="handleScreenTap" bindtouchmove="handleScreenTap"></view>
<view wx:else class="h-64rpx" bindtap="handleScreenTap" bindtouchmove="handleScreenTap"></view>

<!-- 设备控制弹窗 -->
<device-control-popup popup="{{controlPopup}}" bind:popMove="handlePopUp" bind:updateList="updateDeviceList"></device-control-popup>
<before-add-scene-popup show="{{showBeforeAddScenePopup}}" bind:close="handleBeforeAddScenePopupClose" bind:next="handleBeforeAddScenePopupNext" bind:delete="handleBeforeAddScenePopupDelete" bind:edit="handleSceneActionEdit" />
<add-scene-popup actions="{{addSceneActions}}" show="{{showAddScenePopup}}" bind:close="handleAddScenePopupClose" bind:addSuccess="handleShowAddSceneSuccess" bind:return="handleAddScenePopupReturn" />
<batch-edit bind:updateList="updateDeviceList"></batch-edit>

<van-toast id="van-toast" />
<van-dialog use-slot title="子设备离线" show="{{ showDeviceOffline }}" confirm-button-color="#488FFF" confirmButtonText="我知道了" bind:close="handleCloseDeviceOffice">
  <view class="flex-col-center w-full">
    <image src="{{officeDeviceInfo.pic}}" class="w-160rpx h-160rpx mt-70rpx" />
    <view class="flex flex-col mt-88rpx">
      <text class="text-hex-666666 text-28rpx">可能的原因：</text>
      <text class="text-hex-555659 text-24rpx mt-16rpx">1.路由器密码被修改，请为智能网关更改WIFI</text>
      <text class="text-hex-555659 text-24rpx mt-8rpx">2.设备与网关未通电</text>
      <text class="text-hex-555659 text-24rpx mt-8rpx">3.设备与网关距离过远，或有其他遮挡物</text>
      <text class="text-hex-555659 text-24rpx mt-8rpx">4.路由器未通电或网络异常</text>
    </view>
    <view class="h-80rpx"></view>
  </view>
</van-dialog>
