<view class="page-container flex flex-col h-screen">
  <!-- 导航栏 -->
  <nav-bar leftArrow="{{true}}" bind:leftTap="goBack" background="transparent" title="{{pageTitle}}"></nav-bar>

  <view class="grow shrink flex flex-col justify-between pb-128rpx box-border">
    <block wx:if="{{status === 'discover'}}">
      <tips-box text="正在搜索附近的设备…" icon="/assets/img/search-subdevice/searching.png" size="{{ deviceList.length ? 180 : 300}}" textStyle="margin-top: 28rpx;"></tips-box>

      <view wx:if="{{deviceList.length}}" class="px-32rpx pt-86rpx grow shrink flex flex-col">
        <view class="flex flex-row items-center justify-between pb-34rpx">
          <text class="text-26 text-black-59">发现{{deviceList.length}}个附近的设备</text>

          <van-button plain round type="info" size="small" bind:click="selectAll">全选</van-button>
        </view>

        <scroll-view class="grow shrink h-500" scroll-y="{{true}}">
          <view wx:for="{{deviceList}}" wx:key="deviceUuid" class="flex flex-row items-center bg-white rounded-32rpx mb-24rpx px-24rpx py-40rpx">
            <van-checkbox use-icon-slot bind:change="toggleDevice" data-index="{{index}}">
              <view class="ml-10rpx border-4rpx border-solid border-hex-F6F6F8 rounded-full leading-0 p-10rpx">
                <image src="{{item.icon}}" class="w-72 h-72"></image>
              </view>

              <image slot="icon" class="w-48 h-48" src="{{ item.isChecked ? '../../assets/img/search-subdevice/checked.png' : '../../assets/img/search-subdevice/unchecked.png' }}" />
            </van-checkbox>

            <view class="grow pl-32rpx">
              <view class="flex flex-row items-center pb-4rpx" bind:tap="editDevice" data-index="{{index}}">
                <text class="max-w-200 pr-24rpx text-32 text-black-2a single-text">{{ item.name }}</text>

                <image class="w-48 h-48" src="../../assets/img/base/edit.png"></image>
              </view>

              <text class="text-26 text-black-59 opacity-95">{{ item.roomName || defaultRoom.roomName }}</text>
            </view>

            <view class="shrink-0">
              <van-button color="linear-gradient(134deg, #468CFB 32%, #6BA3FC 93%)" type="primary" round bind:click="tryControl" data-index="{{index}}" data-id="{{item.deviceUuid}}" data-mac="{{item.mac}}" loading="{{item.requesting}}" disabled="{{item.requesting}}">试一试</van-button>
            </view>
          </view>
        </scroll-view>

        <van-button class="mt-24rpx" block type="primary" size="large" bind:click="confirmAdd" disabled="{{selectedList.length===0}}">确认添加（已选{{selectedList.length}}个）</van-button>
      </view>
    </block>

    <block wx:if="{{status === 'requesting' && successList.length !== selectedList.length}}">
      <mz-loading wx:if="{{failList.length !== selectedList.length}}" class="{{failList.length === 0 ? 'mt-70rpx' : 'mt-130rpx' }}" text="已添加{{successList.length}}/{{selectedList.length}}个设备" show-progress="{{false}}" stepList="{{[]}}"></mz-loading>

      <view wx:if="{{failList.length > 0}}" class="px-24rpx pt-90rpx grow shrink flex flex-col">
        <view class="flex flex-row items-center justify-between pb-24rpx">
          <text class="text-28 text-hex-000">以下{{failList.length}}个设备添加失败</text>

          <van-button plain round size="small" type="info" bind:click="reAdd">重新添加</van-button>
        </view>

        <scroll-view class="grow shrink h-500" scroll-y="{{true}}">
          <view wx:for="{{failList}}" wx:key="deviceUuid" class="flex flex-row items-center bg-white rounded-32rpx mb-24rpx px-50rpx py-40rpx">
            <view class="border-4rpx border-solid border-hex-F6F6F8 rounded-full leading-0 p-10rpx">
              <image src="{{item.icon}}" class="w-72 h-72"></image>
            </view>

            <view class="pl-32rpx">
              <view class="flex flex-row items-center">
                <text class="pr-24rpx text-32 text-black-2a">{{ item.name }}</text>
              </view>

              <view class="inline-block rounded-12rpx py-6rpx mt-20rpx">
                <text class="pr-12rpx text-26 text-black-59">{{ item.roomName || defaultRoom.roomName }}</text>
              </view>
            </view>
          </view>
        </scroll-view>

        <van-button wx:if="{{(successList.length + failList.length ) === selectedList.length}}" class="mt-24rpx" type="primary" block size="large" bind:click="finish">完成</van-button>
      </view>
    </block>

    <view class="grow flex flex-col justify-between" wx:if="{{status === 'requesting' && successList.length === selectedList.length}}">
      <tips-box text="设备添加成功！" icon="/assets/img/search-subdevice/add-success.png"></tips-box>

      <van-button class="mx-32rpx mt-24rpx" type="primary" block size="large" bind:click="finish">完成</van-button>
    </view>

    <block wx:if="{{status === 'error'}}">
      <tips-box text="未发现附近设备" icon="/assets/img/search-subdevice/no-found.png"></tips-box>

      <view class="grow px-88rpx pt-180rpx">
        <view class="text-28 text-black-2a">
          <text>请排查一下情况：</text>
        </view>

        <view class="py-30rpx text-26 text-hex-666 leading-46rpx">
          <view>
            <text>1、确保子设备已正常通电</text>
          </view>
          <view><text>2、将手机尽量靠近子设备，中间请勿有墙体阻隔</text></view>
        </view>
      </view>

      <van-button class="mx-32rpx mt-24rpx" block type="primary" size="large" bind:click="finish">返回首页</van-button>
    </block>

    <block wx:if="{{status === 'openBle'}}">
      <tips-box text="打开手机蓝牙，以便扫描附近智能设备" icon="/assets/img/search-subdevice/open-ble.png"></tips-box>

      <view class="px-32rpx pt-128rpx">
        <van-button type="primary" block size="large" bind:click="finish">去开启</van-button>
      </view>
    </block>
  </view>
</view>

<edit-device-info show="{{isEditDevice}}" device-name="{{editDeviceInfo.deviceName}}" room-id="{{editDeviceInfo.roomId}}" bind:close="cancelEditDevice" bind:confirm="confirmEditDevice"></edit-device-info>